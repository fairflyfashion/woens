<!DOCTYPE html>
<html>
  <head>
    <title>Home</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/style.css?v=999" />
  </head>
  <body>
    <!-- MOBILE NAV -->
    <header class="m-nav">
      <div class="m-nav-top">
        <span class="menu-btn" onclick="toggleCatMenu()">‚ò∞</span>
        <span class="logo">MyShop</span>
        <a href="cart.html" class="cart">üõí</a>
      </div>

      <div class="m-search">
        <input
          id="mSearch"
          placeholder="Search products..."
          onkeyup="renderProducts()"
        />
        <button>üîç</button>
      </div>
    </header>

    <!-- CATEGORY DRAWER -->
    <div id="catMenu" class="cat-menu">
      <div class="cat-item" onclick="setFilter('men')">Men</div>
      <div class="cat-item" onclick="setFilter('women')">Women</div>
      <div class="cat-item" onclick="setFilter('kids')">Kids</div>
    </div>

    <!-- DESKTOP HEADER -->
    <header class="topbar">
      <h1>My Shop</h1>

      <nav id="navAuth">
        <a href="index.html">Home</a>
        <a href="men.html">Men</a>
        <a href="women.html">Women</a>
        <a href="kids.html">Kids</a>
        <a href="cart.html">Cart</a>

        <div class="more-menu">
          <span class="dots" onclick="toggleUserMenu()">‚ò∞</span>
          <div id="dotMenu" class="dot-dropdown">
            <a href="my-account.html">My Account</a>
            <a href="wishlist.html">Wishlist</a>
            <a href="my-orders.html">My Orders</a>
            <a href="#" onclick="logout()">Logout</a>
          </div>
        </div>
      </nav>

      <input
        class="nav-search"
        id="search"
        placeholder="Search..."
        onkeyup="renderProducts()"
      />

      <select class="nav-select" id="filter" onchange="renderProducts()">
        <option value="all">All</option>
        <option value="men">Men</option>
        <option value="women">Women</option>
        <option value="kids">Kids</option>
      </select>

      <select class="nav-select" id="sort" onchange="renderProducts()">
        <option value="default">Sort</option>
        <option value="low">Low ‚Üí High</option>
        <option value="high">High ‚Üí Low</option>
      </select>
    </header>

    <!-- SLIDER -->
    <div class="slider">
      <img id="slide-img" src="images/slide1.jpg" />
    </div>

    <!-- PRODUCTS -->
    <section class="products">
      <div id="product-list"></div>
    </section>

    <script>
      /* ===== SLIDER ===== */
      let slides = [
        "images/slide1.jpg",
        "images/slide2.jpg",
        "images/slide3.jpg",
      ];
      let si = 0;
      setInterval(() => {
        si = (si + 1) % slides.length;
        document.getElementById("slide-img").src = slides[si];
      }, 3000);

      /* ===== PRODUCTS ===== */
      let products = JSON.parse(localStorage.getItem("products")) || [];
      let list = document.getElementById("product-list");

      function setFilter(val) {
        document.getElementById("filter").value = val;
        toggleCatMenu();
        renderProducts();
      }

      function renderProducts() {
        list.innerHTML = "";
        let q = (search.value || "").toLowerCase();
        let f = filter.value;
        let s = sort.value;

        let data = products.filter(
          (p) =>
            p.name.toLowerCase().includes(q) &&
            (f === "all" || p.category === f)
        );

        if (s === "low") data.sort((a, b) => a.price - b.price);
        if (s === "high") data.sort((a, b) => b.price - a.price);

        if (!data.length) {
          list.innerHTML = "<p>No products found</p>";
          return;
        }

        data.forEach((p) => {
          list.innerHTML += `
    <div class="product-box">
      <img src="${p.img}"
        onclick="openDetails(${p.id})">
      <h3>${p.name}</h3>
      <p>‚Çπ${p.price}</p>
      <p>Stock: ${p.stock}</p>

      ${
        p.stock > 0
          ? `<button onclick="addToCart(${p.id})">Add to Cart</button>`
          : `<p style="color:red">Out of Stock</p>`
      }

      <button onclick="addToWishlist('${p.name}',${p.price})">
        ‚ù§Ô∏è Wishlist
      </button>
    </div>`;
        });
      }

      function addToCart(pid) {
        let cart = JSON.parse(localStorage.getItem("cart")) || [];
        let p = products.find((x) => x.id === pid);
        if (!p || p.stock <= 0) {
          alert("Out of stock");
          return;
        }

        let item = cart.find((i) => i.id === pid);
        if (item) item.qty++;
        else
          cart.push({
            id: p.id,
            name: p.name,
            price: p.price,
            category: p.category,
            img: p.img,
            qty: 1,
          });

        localStorage.setItem("cart", JSON.stringify(cart));
        alert("Added to cart");
      }

      renderProducts();

      /* ===== MENU ===== */
      function toggleUserMenu() {
        let m = document.getElementById("dotMenu");
        m.style.display = m.style.display === "block" ? "none" : "block";
      }

      function toggleCatMenu() {
        let m = document.getElementById("catMenu");
        m.style.display = m.style.display === "block" ? "none" : "block";
      }

      document.addEventListener("click", (e) => {
        let d = document.querySelector(".dots");
        let m = document.getElementById("dotMenu");
        if (m && d && !m.contains(e.target) && !d.contains(e.target)) {
          m.style.display = "none";
        }
      });

      /* ===== AUTH ===== */
      let user = JSON.parse(localStorage.getItem("currentUser"));
      if (!user) {
        document.getElementById("dotMenu").innerHTML = `
    <a href="login.html">Login</a>
    <a href="signup.html">Sign Up</a>`;
      }

      function logout() {
        localStorage.removeItem("currentUser");
        location.reload();
      }

      function addToWishlist(name, price) {
        let user = JSON.parse(localStorage.getItem("currentUser"));
        if (!user) {
          alert("Login first");
          location.href = "login.html";
          return;
        }
        let w = JSON.parse(localStorage.getItem("wishlist")) || [];
        if (w.find((x) => x.userId === user.id && x.name === name)) {
          alert("Already in wishlist");
          return;
        }
        w.push({ userId: user.id, name, price });
        localStorage.setItem("wishlist", JSON.stringify(w));
        alert("Added to wishlist ‚ù§Ô∏è");
      }

      function openDetails(id) {
        location.href = "product-details.html?id=" + id;
      }
    </script>
  </body>
</html>
